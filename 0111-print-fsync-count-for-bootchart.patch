From 167d869b23273fb4cbf856ec42cdacbb2b9ed21a Mon Sep 17 00:00:00 2001
From: Arjan van de Ven <arjan@linux.intel.com>
Date: Tue, 20 Jun 2017 20:19:08 +0000
Subject: [PATCH 11/32] print fsync count for bootchart

---
 block/blk-core.c      | 3 +++
 include/linux/sched.h | 1 +
 kernel/sched/debug.c  | 1 +
 3 files changed, 5 insertions(+)

diff --git a/block/blk-core.c b/block/blk-core.c
index 651057c41..857165c37 100644
--- a/block/blk-core.c
+++ b/block/blk-core.c
@@ -828,6 +828,9 @@ void submit_bio(struct bio *bio)
 	} else if (bio_op(bio) == REQ_OP_WRITE) {
 		count_vm_events(PGPGOUT, bio_sectors(bio));
 	}
+	
+	if (bio->bi_opf & REQ_PREFLUSH)
+		current->fsync_count++;
 
 	/*
 	 * If we're reading data that is part of the userspace workingset, count
diff --git a/include/linux/sched.h b/include/linux/sched.h
index 8d82d6d32..ebbe7cb0b 100644
--- a/include/linux/sched.h
+++ b/include/linux/sched.h
@@ -1052,6 +1052,7 @@ struct task_struct {
 	/* Cached requested key. */
 	struct key			*cached_requested_key;
 #endif
+	int fsync_count;
 
 	/*
 	 * executable name, excluding path.
diff --git a/kernel/sched/debug.c b/kernel/sched/debug.c
index 667876da8..0813b7d73 100644
--- a/kernel/sched/debug.c
+++ b/kernel/sched/debug.c
@@ -460,6 +460,7 @@ static void print_cfs_group_stats(struct seq_file *m, int cpu, struct task_group
 	PN(se->exec_start);
 	PN(se->vruntime);
 	PN(se->sum_exec_runtime);
+	P(fsync_count);
 
 	if (schedstat_enabled()) {
 		struct sched_statistics *stats;
-- 
2.38.1

